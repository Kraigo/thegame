"use strict";function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,i){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?e:i}function _inherits(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(e,i):e.__proto__=i)}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,i){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?e:i}function _inherits(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(e,i):e.__proto__=i)}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,i){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!i||"object"!=typeof i&&"function"!=typeof i?e:i}function _inherits(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Super expression must either be null or a function, not "+typeof i);e.prototype=Object.create(i&&i.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),i&&(Object.setPrototypeOf?Object.setPrototypeOf(e,i):e.__proto__=i)}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Basis=function(){function e(i){_classCallCheck(this,e),this.game=i,this.size={width:16,height:16,radius:16},this.position={x:0,y:0},this.direction={x:0,y:0},this.look={x:0,y:0},this.lookAngel=0,this.speed=0,this.velocity=0,this.gravity=.5,this.animation={name:null,state:"stand",keyframe:0,rate:5,end:!1},this.health={max:100,current:100},this.attack={damageMin:1,damageMax:2,range:0},this.willDie=!1,this.willAttack=!1,this.rotationSpeed=.05,this.density=0}return _createClass(e,[{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.rect(this.position.x-this.game.camera.x,this.position.y-this.game.camera.y,this.size.width,this.size.height),this.game.screen.stroke()}},{key:"healthBar",value:function i(){var i={x:this.position.x-this.game.camera.x,y:this.position.y-this.game.camera.y-5,height:3,width:this.size.width*(this.health.current/this.health.max)};this.game.screen.beginPath(),this.game.screen.rect(i.x,i.y,this.size.width,i.height),this.game.screen.fillStyle="red",this.game.screen.fillRect(i.x,i.y,i.width,i.height),this.game.screen.stroke()}},{key:"update",value:function(){}},{key:"colliding",value:function(e,i){var t=e.x-i.x,s=e.y-i.y,a=Math.sqrt(t*t+s*s);return a<e.r+i.r}},{key:"collidingSqr",value:function(e){return!(this.position.x+this.size.width<=e.position.x||this.position.y+this.size.height<=e.position.y||this.position.x>=e.position.x+e.size.width||this.position.y>=e.position.y+e.size.height)}},{key:"collidingBody",value:function(e){return this!=e&&this.colliding({x:this.position.x,y:this.position.y,r:this.size.width/2},{x:e.position.x,y:e.position.y,r:e.size.width/2})}},{key:"brotherColliding",value:function(){for(var e,i=this.constructor,t=0;t<this.game.bodies.length;t++)if(e=this.game.bodies[t],e instanceof i&&this.collidingBody(e)){if(this.position.x<e.position.x){var s=(this.position.x+this.size.width-e.position.x)/2*e.density;this.position.x-=s,e.position.x+=s}else if(this.position.x>e.position.x){var s=(e.position.x-this.position.x+this.size.width)/2*e.density;this.position.x+=s,e.position.x-=s}if(this.position.y<e.position.y){var s=(this.position.y+this.size.height-e.position.y)/2*e.density;this.position.y-=s,e.position.y+=s}else if(this.position.y>e.position.y){var s=(e.position.y-this.position.y+this.size.height)/2*e.density;this.position.y+=s,e.position.y-=s}}}},{key:"isOuterCamera",value:function(){return!this.collidingSqr(this)}},{key:"fixStuckWorld",value:function(){this.position.x<0?(this.position.x=0,this.direction.x<0&&(this.direction.x=-this.direction.x)):this.position.x+this.size.width>this.game.world.width&&(this.position.x=this.game.world.width-this.size.width,this.direction.x>0&&(this.direction.x=-this.direction.x)),this.position.y<0?(this.position.y=0,this.direction.y<0&&(this.direction.y=-this.direction.y)):this.position.y+this.size.height>this.game.world.height&&(this.position.y=this.game.world.height-this.size.height,this.direction.y>0&&(this.direction.y=-this.direction.y))}},{key:"directionTo",value:function(e){var i=e.position.x+e.size.width/2-(this.position.x+this.size.width/2),t=e.position.y+e.size.height/2-(this.position.y+this.size.height/2),s=Math.sqrt(i*i+t*t);return{x:i/s,y:t/s}}},{key:"vectorAngle",value:function(e,i){Math.atan2(i.y-e.y,i.x-e.x);return 180*Math.atan2(i.y-e.y,i.x-e.x)/Math.PI}},{key:"getRandomInt",value:function(e,i){return Math.floor(Math.random()*(i-e+1))+e}},{key:"changeAnimation",value:function(e){this.animation.state!=e&&(this.animation.state=e,this.animation.keyframe=0,this.animation.end=!1)}},{key:"kill",value:function(){this.willDie=!0,this.changeAnimation("die")}},{key:"hit",value:function(e){this.health.current-=e,this.health.current<=0&&(this.health.current=0,this.kill())}},{key:"isReach",value:function(e){return this!=e&&this.colliding({x:this.position.x,y:this.position.y,r:this.size.width/2},{x:e.position.x,y:e.position.y,r:this.attack.range+this.size.width/2})}},{key:"faceBarrier",value:function(e){for(var i,t=0;t<this.game.stage.levelSolid.length;t++){i={position:{x:this.game.stage.levelSolid[t].x,y:this.game.stage.levelSolid[t].y},size:{width:this.game.stage.levelSolid[t].width,height:this.game.stage.levelSolid[t].height}};var s=!1;if(this.collidingSqr(i)){var a=this.directionTo(i),o=this.size.width/2+i.size.width/2;this.position.x+=-a.x*o*.1,this.position.y+=-a.y*o*.1,s=!0}e&&s&&(this.position.x<i.position.x&&this.direction.x>0||this.position.x>i.position.x&&this.direction.x<0?this.direction.x=-this.direction.x:(this.position.y<i.position.y&&this.direction.y>0||this.position.y>i.position.y&&this.direction.y<0)&&(this.direction.y=-this.direction.y))}}}]),e}(),_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Asteroid=function(e){function i(e,t){_classCallCheck(this,i);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,e));return s.size={width:t.width,height:t.height},s.position={x:t.x||Math.floor(Math.random()*(s.game.world.width-s.size.width)),y:t.y||Math.floor(Math.random()*(s.game.world.height-s.size.height))},s.direction={x:Math.random(),y:Math.random()},s.attack.range=5,s.speed=2*Math.random(),s.speed=3,s.animation.name="monster",s.target=t.target||null,s.density=.03,s}return _inherits(i,e),_createClass(i,[{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.arc(this.position.x+this.size.width/2-this.game.camera.x,this.position.y+this.size.height/2-this.game.camera.y,(this.size.width+this.size.height)/6,0,2*Math.PI),this.game.screen.fillStyle="rgba(0,0,0,0.2)",this.game.screen.fill();var e=this.vectorAngle({x:this.position.x-this.game.camera.x,y:this.position.y-this.game.camera.y},{x:this.position.x-this.game.camera.x+this.look.x,y:this.position.y-this.game.camera.y+this.look.y});this.game.sprite.draw(this,e),this.healthBar()}},{key:"update",value:function(){this.brotherColliding(),this.willDie||(this.willAttack||this.isReach(this.target)?(this.willAttack=!0,this.changeAnimation("attack"),this.animation.end&&(this.willAttack=!1,this.isReach(this.target)&&(console.log("hit you"),this.target.hit(this.getRandomInt(this.attack.damageMin,this.attack.damageMax))),this.changeAnimation("stand"))):this.speed?(this.target&&this.routeToTarget(),this.changeAnimation("walk"),this.faceBarrier(),this.position.x+=this.direction.x*this.speed,this.position.y+=this.direction.y*this.speed):this.changeAnimation("stand"))}},{key:"routeToTarget",value:function(){var e=this.directionTo({position:{x:this.target.position.x,y:this.target.position.y},size:{width:this.size.width,height:this.size.height}});this.direction.x+=(e.x-this.direction.x)*this.rotationSpeed,this.direction.y+=(e.y-this.direction.y)*this.rotationSpeed,this.look.x+=(e.x-this.look.x)*this.rotationSpeed,this.look.y+=(e.y-this.look.y)*this.rotationSpeed}}]),i}(Basis),_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Builder=function(){function e(i){_classCallCheck(this,e),this.game=i,this.size={width:24,height:24},this.position={x:0,y:0,sx:0,sy:0},this.speed=3,this.material="",this.addActivity()}return _createClass(e,[{key:"update",value:function(){this.position.sx=this.game.point.x+this.game.camera.x-(this.game.point.x+this.game.camera.x)%this.size.width,this.position.sy=this.game.point.y+this.game.camera.y-(this.game.point.y+this.game.camera.y)%this.size.width,this.move()}},{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.rect(this.position.sx-this.game.camera.x,this.position.sy-this.game.camera.y,this.size.width,this.size.height),this.game.screen.stroke()}},{key:"move",value:function(){this.position.sx,this.position.sy;this.game.keyboard.isPressed("A")?this.position.x-=this.speed:this.game.keyboard.isPressed("D")&&(this.position.x+=this.speed),this.game.keyboard.isPressed("W")?this.position.y-=this.speed:this.game.keyboard.isPressed("S")&&(this.position.y+=this.speed)}},{key:"addActivity",value:function(){var e=this,i=this.game.keyboard;document.addEventListener("mousedown",function(i){e.game.stage.build([e.material,e.position.sx,e.position.sy])}),document.addEventListener("keydown",function(t){console.log(1),i.isPressed("F")&&(i.isClicked("1",t.keyCode)?e.material="wall_1":i.isClicked("2",t.keyCode)?e.material="wall_2":i.isClicked("3",t.keyCode)?e.material="wall_3":i.isClicked("4",t.keyCode)?e.material="wall_4":i.isClicked("5",t.keyCode)?e.material="wall_5":i.isClicked("6",t.keyCode)?e.material="wall_6":i.isClicked("7",t.keyCode)?e.material="wall_7":i.isClicked("8",t.keyCode)?e.material="wall_8":i.isClicked("9",t.keyCode)&&(e.material="wall_9")),i.isPressed("G")&&(i.isClicked("1",t.keyCode)?e.material="wall_10":i.isClicked("2",t.keyCode)?e.material="wall_11":i.isClicked("3",t.keyCode)?e.material="wall_12":i.isClicked("4",t.keyCode)?e.material="wall_13":i.isClicked("5",t.keyCode)?e.material="wall_14":i.isClicked("6",t.keyCode)?e.material="wall_15":i.isClicked("7",t.keyCode)?e.material="wall_16":i.isClicked("8",t.keyCode)?e.material="wall_17":i.isClicked("9",t.keyCode)?e.material="wall_18":i.isClicked("0",t.keyCode)&&(e.material="wall_19")),i.isClicked("C",t.keyCode)&&e.game.stage.clean(),i.isClicked("R",t.keyCode)&&e.game.stage.remove(e.position.sx,e.position.sy),i.isClicked("F3",t.keyCode)&&e.game.stage.logLevel(),i.isClicked("F4",t.keyCode)&&e.game.stage.loadLevel("1")})}}]),e}(),_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Bullet=function(e){function i(e,t,s){_classCallCheck(this,i);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,e));return a.size.width=24,a.size.height=24,a.position.x=t.x-a.size.width/2,a.position.y=t.y-a.size.height/2,a.direction=t.direction,a.speed=5,a.animation.name="bullet",a.attack.damage=t.damage,a.owner=s,a.timer=a.game.timer,a}return _inherits(i,e),_createClass(i,[{key:"update",value:function(){this.isOuterCamera()&&this.game.removeBody(this);for(var e,t=0;t<this.game.bodies.length;t++)e=this.game.bodies[t],this.willDie||e.willDie||this.owner===e||e instanceof i||!this.collidingBody(e)||(this.kill(),this.speed=0,e.hit(this.attack.damage));this.position.x+=this.direction.x*this.speed,this.position.y+=this.direction.y*this.speed,this.faceBarrier(!0),this.game.timer>this.timer+100&&(this.kill(),this.speed=0)}},{key:"render",value:function(){var e=this.vectorAngle({x:this.position.x-this.game.camera.x,y:this.position.y-this.game.camera.y},{x:this.position.x-this.game.camera.x+this.direction.x*this.speed,y:this.position.y-this.game.camera.y+this.direction.y*this.speed});this.game.sprite.draw(this,e)}}]),i}(Basis),_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Game=function(){function e(){_classCallCheck(this,e);var i=this;this.editMode=!1,this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.canvas.width=document.body.offsetWidth-10,this.canvas.height=document.body.offsetHeight-10,this.screen=this.canvas.getContext("2d"),this.screen.imageSmoothingEnabled=!1,this.camera={x:0,y:0,width:this.canvas.width,height:this.canvas.height,target:null},this.world={width:792,height:792},this.player=new Player(i),this.playerControl=new PlayerControl(i),this.socket=new Socket(i),this.builder=null,this.keyboard=new Keyboard,this.point=new Point(i.canvas),this.sprite=new Sprite(i),this.stage=new Stage(i),this.lastTick=new Date,this.timer=0,this.camera.target=this.player,this.bodies=[],this.addBody(this.player);for(var t=0;0>t;t++)i.addBody(new Asteroid(i,{target:i.player,width:48,height:48}));var s=function a(){i.update(),i.render(),requestAnimationFrame(a)};s(),i.stage.loadLevel("1"),this.modeToggler()}return _createClass(e,[{key:"render",value:function(){this.screen.clearRect(0,0,this.camera.width,this.camera.height);var e=new Date,i=Math.round(1e3/(e-this.lastTick));this.lastTick=e,this.stage.render(),this.debug(["FPS: "+i,"Obj count: "+this.bodies.length,"Stage count: "+this.stage.level.length,"Camera (x: "+this.camera.x.toFixed()+", y: "+this.camera.y.toFixed()+")","Player (x: "+this.player.position.x.toFixed()+", y: "+this.player.position.y.toFixed()+")","Player dir(x: "+this.player.direction.x+", y: "+this.player.direction.y+")"]),this.screen.rect(0-this.camera.x,0-this.camera.y,this.world.width,this.world.height),this.screen.stroke();for(var t,s=0;s<this.bodies.length;s++)t=this.bodies[s],this.isCameraShow(this.bodies[s])&&t.render()}},{key:"update",value:function(){this.timer++,this.camera.x=this.camera.target.position.x-this.camera.width/2+this.camera.target.size.width/2,this.camera.y=this.camera.target.position.y-this.camera.height/2+this.camera.target.size.height/2,this.camera.x+=.2*(this.point.x-this.camera.width/2),this.camera.y+=.2*(this.point.y-this.camera.height/2),this.playerControl.update();for(var e,i=0;i<this.bodies.length;i++)e=this.bodies[i],e.willDie&&e.animation.end?(this.removeBody(e),i--):e.update()}},{key:"addBody",value:function(e){this.bodies.push(e)}},{key:"removeBody",value:function(e){Array.isArray(e)||(e=[e]);for(var i=0;i<e.length;i++)for(var t=0;t<this.bodies.length;t++)e[i]==this.bodies[t]&&(this.bodies.splice(t,1),t--)}},{key:"debug",value:function(e){this.screen.fillStyle="#000";for(var i=0;i<e.length;i++)this.screen.fillText(e[i],10,18*(i+1));this.screen.fillText("W",40,this.camera.height-40),this.screen.fillText("S",40,this.camera.height-20),this.screen.fillText("A",20,this.camera.height-20),this.screen.fillText("D",60,this.camera.height-20),this.screen.beginPath(),this.screen.moveTo(35,this.camera.height-55),this.screen.lineTo(55,this.camera.height-55),this.screen.lineTo(55,this.camera.height-35),this.screen.lineTo(75,this.camera.height-35),this.screen.lineTo(75,this.camera.height-15),this.screen.lineTo(15,this.camera.height-15),this.screen.lineTo(15,this.camera.height-35),this.screen.lineTo(35,this.camera.height-35),this.screen.lineTo(35,this.camera.height-55),this.screen.stroke()}},{key:"isCameraShow",value:function(e){return!(e.position.x+e.size.width<this.camera.x&&e.position.x>this.camera.width&&e.position.y+e.size.height<this.camera.y&&e.position.y>this.camera.width)}},{key:"modeToggler",value:function(){var e=this;document.addEventListener("keydown",function(i){113==i.keyCode&&(e.builder=new Builder(e),e.camera.target=e.builder,e.bodies=[],e.addBody(e.builder))})}}]),e}(),Keyboard=function e(){_classCallCheck(this,e);var i={},t={SPACE:32,A:65,W:87,D:68,S:83,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,F:70,G:71,H:72,C:67,R:82,F2:113,F3:114,F4:115,F5:116,LEFT:37,UP:38,RIGHT:39,DOWN:40};document.addEventListener("keydown",function(e){e.preventDefault(),i[e.keyCode]=!0}),document.addEventListener("keyup",function(e){i[e.keyCode]=!1}),this.isPressed=function(e){return e=e.toUpperCase(),i[t[e]]},this.isClicked=function(e,i){return t[e]===i},this.keyCode=function(e){return e=e.toUpperCase(),t[e]}},_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Player=function(e){function i(e,t){_classCallCheck(this,i),t=t||{};var s=_possibleConstructorReturn(this,Object.getPrototypeOf(i).call(this,e));return s.id=null,s.speed=3,s.size.width=48,s.size.height=48,s.position.x=t.x||e.world.width/2-s.size.width/2,s.position.y=t.y||e.world.height/2-s.size.height/2,s.shooting={start:!1,bullet:1,rate:3,reload:0},s.attack={damageMin:5,damageMax:10,range:10},s.animation.name="player",s}return _inherits(i,e),_createClass(i,[{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.arc(this.position.x+this.size.width/2-this.game.camera.x,this.position.y+this.size.height/2-this.game.camera.y,(this.size.width+this.size.height)/6,0,2*Math.PI),this.game.screen.fillStyle="rgba(0,0,0,0.2)",this.game.screen.fill(),this.game.sprite.draw(this,this.lookAngel),this.healthBar()}},{key:"update",value:function(){this.shot(),this.move()}},{key:"move",value:function(){this.faceBarrier(),this.position.x+=this.direction.x*this.speed,this.position.y+=this.direction.y*this.speed,this.direction.x||this.direction.y?this.changeAnimation("walk"):this.changeAnimation("stand")}},{key:"shot",value:function(){if(!this.shooting.bullet&&++this.shooting.reload>=60/this.shooting.rate&&(this.shooting.bullet=1,this.shooting.reload=0),this.shooting.bullet&&this.shooting.start){this.shooting.bullet=0;var e={x:this.position.x+this.size.width/2,y:this.position.y+this.size.height/2,direction:this.directionTo({position:{x:this.game.point.x+this.game.camera.x,y:this.game.point.y+this.game.camera.y},size:{width:0,height:0}}),damage:this.getRandomInt(this.attack.damageMin,this.attack.damageMax)};this.game.addBody(new Bullet(this.game,e,this.game.player)),this.game.socket.shot(e)}}}]),i}(Basis),_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),PlayerControl=function(){function e(i){_classCallCheck(this,e),this.game=i,setInterval(function(){i.player&&(i.socket.move(i.player),!i.player.willDie&&i.player.health.current<=0&&this.game.socket.kill(this.id))},50)}return _createClass(e,[{key:"update",value:function(){this.move(),this.shot(),this.rotate()}},{key:"move",value:function(){var e=this.game.player;e.direction.x=0,e.direction.y=0,this.game.keyboard.isPressed("A")?e.direction.x=-1:this.game.keyboard.isPressed("D")&&(e.direction.x=1),this.game.keyboard.isPressed("W")?e.direction.y=-1:this.game.keyboard.isPressed("S")&&(e.direction.y=1)}},{key:"shot",value:function(){this.game.player.shooting.start=this.game.point.isPressed("LEFT")||this.game.keyboard.isPressed("SPACE")}},{key:"rotate",value:function(){this.game.player.lookAngel=this.game.player.vectorAngle({x:this.game.player.position.x-this.game.camera.x+this.game.player.size.width/2,y:this.game.player.position.y-this.game.camera.y+this.game.player.size.width/2},{x:this.game.point.x,y:this.game.point.y})}}]),e}(),Point=function i(e){_classCallCheck(this,i);var t=this,s={},a={LEFT:0,RIGHT:2,MIDDLE:1};this.x=0,this.y=0,e.addEventListener("mousemove",function(e){t.x=e.clientX,t.y=e.clientY}),e.addEventListener("mousedown",function(e){s[e.button]=!0}),e.addEventListener("mouseup",function(e){e.preventDefault(),s[e.button]=!1}),this.isPressed=function(e){return e=e.toUpperCase(),s[a[e]]}},_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Socket=function(){function e(i){function t(e){i.player.id=e.socketId;for(var t=0;t<e.game.length;t++)e.socketId===e.game[t].socketId?(i.player.id=e.socketId,i.player.position=e.game[t].position):o(e.game[t]);r.move(i.player)}function s(e){c[e.socketId]&&(c[e.socketId].willDie=!0,delete c[e.socketId])}function a(e){c[e.socketId]||o(e),c[e.socketId].position=e.position,c[e.socketId].lookAngel=e.lookAngel,c[e.socketId].direction=e.direction}function o(e){var t=new Player(i,e.position);c[e.socketId]=t,c[e.socketId].id=e.socketId,c[e.socketId].lookAngel=e.lookAngel,i.bodies.push(t)}function n(e){i.addBody(new Bullet(i,e.bullet,c[e.socketId]))}function h(e){i.player.id==e.socketId&&i.player&&i.player.kill(),c[e.socketId]&&c[e.socketId].kill()}_classCallCheck(this,e);var r=this,l=io.connect();this.socket=l;var c={};l.on("connected",t),l.on("leave",s),l.on("move",a),l.on("join",o),l.on("bullet",n),l.on("kill",h)}return _createClass(e,[{key:"move",value:function(e){this.socket.emit("move",{position:e.position,lookAngel:e.lookAngel,direction:e.direction})}},{key:"shot",value:function(e){this.socket.emit("bullet",e)}},{key:"kill",value:function(e){this.socket.emit("kill",e)}}]),e}(),_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Sprite=function(){function e(i){_classCallCheck(this,e),this.game=i,this.dir="/sprites/sprite.png",this.image=new Image,this.image.src=this.dir,this.size={width:48,height:48},this.collection={player:{stand:[{x:0,y:0}],walk:[{x:0,y:0},{x:48,y:0},{x:96,y:0},{x:144,y:0},{x:0,y:48},{x:48,y:48},{x:96,y:48},{x:144,y:48}],die:[{x:0,y:336},{x:0,y:336},{x:48,y:336},{x:48,y:336}]},monster:{stand:[{x:0,y:144}],walk:[{x:0,y:144},{x:48,y:144},{x:96,y:144},{x:144,y:144},{x:0,y:192},{x:48,y:192},{x:96,y:192},{x:144,y:192}],bite:[{x:0,y:240},{x:48,y:240},{x:96,y:240}],attack:[{x:0,y:288},{x:48,y:288},{x:96,y:288},{x:144,y:288},{x:192,y:288}],die:[{x:0,y:336},{x:0,y:336},{x:48,y:336},{x:48,y:336}]},bullet:{stand:[{x:0,y:96,w:24,h:24}],die:[{x:0,y:120,w:24,h:24},{x:24,y:120,w:24,h:24}]}}}return _createClass(e,[{key:"draw",value:function(e,i){var t=e.position.x+e.size.width/2-this.game.camera.x,s=e.position.y+e.size.height/2-this.game.camera.y;i-=90;var a=this.getFrame(e.animation);this.game.screen.save(),this.game.screen.translate(t,s),this.game.screen.rotate(i*Math.PI/180),this.game.screen.drawImage(this.image,a.x,a.y,a.w||this.size.width,a.h||this.size.height,-e.size.width/2,-e.size.width/2,e.size.width,e.size.height),this.game.screen.translate(-t,-s),this.game.screen.rotate(-i*Math.PI/180),this.game.screen.restore()}},{key:"getFrame",value:function(e){var i=this.collection[e.name][e.state];return this.game.timer%e.rate==0&&(i.length-1>e.keyframe?e.keyframe+=1:(e.keyframe=0,e.end=!0)),i[e.keyframe]}}]),e}(),_createClass=function(){function e(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(i,t,s){return t&&e(i.prototype,t),s&&e(i,s),i}}(),Stage=function(){function e(i){_classCallCheck(this,e);this.game=i,this.dir="/sprites/tileset.png",this.image=new Image,this.image.src=this.dir,this.current=1,this.size={width:24,height:24},this.cleaned=!0,this.level=[],this.levelSolid=[];for(var t=0;t<this.game.world.width;t+=this.size.width)for(var s=0;s<this.game.world.height;s+=this.size.height)this.build(["wall_5",t,s])}return _createClass(e,[{key:"render",value:function(){for(var e=0;e<this.level.length;e++)this.draw(this.level[e])}},{key:"draw",value:function(e){e.x+this.size.width>this.game.camera.x&&e.x<this.game.camera.x+this.game.camera.width&&e.y+this.size.height>this.game.camera.y&&e.y<this.game.camera.y+this.game.camera.height&&this.game.screen.drawImage(this.image,e.sx,e.sy,this.size.width,this.size.height,e.x-this.game.camera.x,e.y-this.game.camera.y,this.size.width,this.size.height)}},{key:"build",value:function(e){var i={x:e[1],y:e[2]};switch(e[0]){case"floor_1":i.sx=0,i.sy=72;break;case"floor_2":i.sx=24,i.sy=72;break;case"floor_3":i.sx=48,i.sy=72;break;case"floor_4":i.sx=0,i.sy=96;break;case"floor_5":i.sx=24,i.sy=96;break;case"floor_6":i.sx=48,i.sy=96;break;case"floor_7":i.sx=0,i.sy=120;break;case"floor_8":i.sx=24,i.sy=120;break;case"floor_9":i.sx=48,i.sy=120;break;case"wall_1":i.sx=0,i.sy=144,i.solid=!0;break;case"wall_2":i.sx=24,i.sy=144,i.solid=!0;break;case"wall_3":i.sx=48,i.sy=144,i.solid=!0;break;case"wall_4":i.sx=0,i.sy=168,i.solid=!0;break;case"wall_5":i.sx=24,i.sy=168;break;case"wall_6":i.sx=48,i.sy=168,i.solid=!0;break;case"wall_7":i.sx=0,i.sy=192,i.solid=!0;break;case"wall_8":i.sx=24,i.sy=192,i.solid=!0;break;case"wall_9":i.sx=48,i.sy=192,i.solid=!0;break;case"wall_10":i.sx=72,i.sy=144,i.solid=!0;break;case"wall_11":i.sx=72,i.sy=168,i.solid=!0;break;case"wall_12":i.sx=72,i.sy=192,i.solid=!0;break;case"wall_13":i.sx=96,i.sy=192,i.solid=!0;break;case"wall_14":i.sx=120,i.sy=192,i.solid=!0;break;case"wall_15":i.sx=144,i.sy=192,i.solid=!0;break;case"wall_16":i.sx=96,i.sy=144,i.solid=!0;break;case"wall_17":i.sx=118,i.sy=144,i.solid=!0;break;case"wall_18":i.sx=96,i.sy=168,i.solid=!0;break;case"wall_19":i.sx=120,i.sy=168,i.solid=!0}this.cleaned=!1,this.level.push(i),i.solid&&this.addSolid(i.x,i.y)}},{key:"clean",value:function(){if(!this.cleaned){for(var e,i=0;i<this.level.length;i++){e=this.level[i];for(var t,s=0;s<this.level.length;s++)if(t=this.level[s],e!=t&&e.x===t.x&&e.y===t.y){this.level.splice(i,1),i--;break}}this.cleaned=!0}}},{key:"remove",value:function(e,i){for(var t=0;t<this.level.length;t++)if(this.level[t].x===e&&this.level[t].y===i){this.level.splice(t,1);break}}},{key:"loadLevel",value:function(e){var i=new XMLHttpRequest,t=this;i.overrideMimeType("application/json"),i.open("GET","/levels/level_"+e+".json",!0),i.onreadystatechange=function(){if(4==i.readyState&&"200"==i.status){for(var e=JSON.parse(i.responseText),s=0;s<e.length;s++)t.level.push(e[s]),e[s].solid&&t.addSolid(e[s].x,e[s].y);t.simplifySolid()}},i.send(null)}},{key:"logLevel",value:function(){console.log(JSON.stringify(this.level))}},{key:"addSolid",value:function(e,i){this.levelSolid.push({x:e,y:i,width:this.size.width,height:this.size.height})}},{key:"simplifySolid",value:function(){console.log("before simplify",this.levelSolid.length);for(var e,i=0;i<this.levelSolid.length;i++)if(e=this.levelSolid[i])for(var t,s=0;s<this.levelSolid.length;s++)if(t=this.levelSolid[s],t&&e!=t&&e.x<=t.x+t.width&&e.x+e.width>=t.x&&e.y<=t.y+t.height&&e.height+e.y>=t.y&&(e.x===t.x&&e.height===t.height||e.y===t.y&&e.width===t.width)){t.x<e.x&&(e.x-=t.width),t.y<e.y&&(e.y-=t.height),e.width+=t.x-e.x,e.height+=t.y-e.y,delete this.levelSolid[s];break}this.levelSolid=this.levelSolid.filter(function(e){return!!e}),console.log("after simplify",this.levelSolid.length)}}]),e}(),Vector=function t(e,i){_classCallCheck(this,t),this.x=e,this.y=i};