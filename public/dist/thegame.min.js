"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Basis=function(){function e(t){_classCallCheck(this,e),this.game=t,this.size={width:16,height:16,radius:16},this.position={x:0,y:0},this.direction={x:0,y:0},this.look={x:0,y:0},this.lookAngel=0,this.speed=0,this.velocity=0,this.gravity=.5,this.animation={name:null,state:"stand",keyframe:0,rate:5,end:!1},this.health={max:100,current:100},this.attack={damageMin:1,damageMax:2,range:0},this.willDie=!1,this.willAttack=!1,this.rotationSpeed=.05,this.density=0}return _createClass(e,[{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.rect(this.position.x-this.game.camera.x,this.position.y-this.game.camera.y,this.size.width,this.size.height),this.game.screen.stroke()}},{key:"healthBar",value:function t(){var t={x:this.position.x-this.game.camera.x,y:this.position.y-this.game.camera.y-5,height:3,width:this.size.width*(this.health.current/this.health.max)};this.game.screen.beginPath(),this.game.screen.rect(t.x,t.y,this.size.width,t.height),this.game.screen.fillStyle="red",this.game.screen.fillRect(t.x,t.y,t.width,t.height),this.game.screen.stroke()}},{key:"update",value:function(){}},{key:"colliding",value:function(e,t){var i=e.x-t.x,s=e.y-t.y,a=Math.sqrt(i*i+s*s);return a<e.r+t.r}},{key:"collidingSqr",value:function(e){return!(this.position.x+this.size.width<e.position.x||this.position.y+this.size.height<e.position.y||this.position.x>e.position.x+e.size.width||this.position.y>e.position.y+e.size.height)}},{key:"collidingBody",value:function(e){return this!=e&&this.colliding({x:this.position.x,y:this.position.y,r:this.size.width/2},{x:e.position.x,y:e.position.y,r:e.size.width/2})}},{key:"brotherColliding",value:function(){for(var e,t=this.constructor,i=0;i<this.game.bodies.length;i++)if(e=this.game.bodies[i],e instanceof t&&this.collidingBody(e)){if(this.position.x<e.position.x){var s=(this.position.x+this.size.width-e.position.x)/2*e.density;this.position.x-=s,e.position.x+=s}else if(this.position.x>e.position.x){var s=(e.position.x-this.position.x+this.size.width)/2*e.density;this.position.x+=s,e.position.x-=s}if(this.position.y<e.position.y){var s=(this.position.y+this.size.height-e.position.y)/2*e.density;this.position.y-=s,e.position.y+=s}else if(this.position.y>e.position.y){var s=(e.position.y-this.position.y+this.size.height)/2*e.density;this.position.y+=s,e.position.y-=s}}}},{key:"isOuterCamera",value:function(){return!this.collidingSqr(this)}},{key:"fixStuckWorld",value:function(){this.position.x<0?(this.position.x=0,this.direction.x<0&&(this.direction.x=-this.direction.x)):this.position.x+this.size.width>this.game.world.width&&(this.position.x=this.game.world.width-this.size.width,this.direction.x>0&&(this.direction.x=-this.direction.x)),this.position.y<0?(this.position.y=0,this.direction.y<0&&(this.direction.y=-this.direction.y)):this.position.y+this.size.height>this.game.world.height&&(this.position.y=this.game.world.height-this.size.height,this.direction.y>0&&(this.direction.y=-this.direction.y))}},{key:"directionTo",value:function(e){var t=e.position.x+e.size.width/2-(this.position.x+this.size.width/2),i=e.position.y+e.size.height/2-(this.position.y+this.size.height/2),s=Math.sqrt(t*t+i*i);return{x:t/s,y:i/s}}},{key:"vectorAngle",value:function(e,t){Math.atan2(t.y-e.y,t.x-e.x);return 180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI}},{key:"getRandomInt",value:function(e,t){return Math.floor(Math.random()*(t-e+1))+e}},{key:"changeAnimation",value:function(e){this.animation.state!=e&&(this.animation.state=e,this.animation.keyframe=0,this.animation.end=!1)}},{key:"kill",value:function(){this.willDie=!0,this.changeAnimation("die")}},{key:"hit",value:function(e){this.health.current-=e,this.health.current<=0&&(this.health.current=0,this.kill())}},{key:"faceBarrier",value:function(e){for(var t,i=0;i<this.game.stage.levelSolid.length;i++){t={position:{x:this.game.stage.levelSolid[i].x,y:this.game.stage.levelSolid[i].y},size:{width:this.game.stage.levelSolid[i].width,height:this.game.stage.levelSolid[i].height}};var s=!1;this.collidingSqr(t)&&(this.position.x<t.position.x?this.position.x-=this.direction.x*this.speed:this.position.x>t.position.x+t.size.height&&(this.position.x+=this.direction.x*this.speed),this.position.y+this.size.height<t.position.y?this.position.y-=this.direction.y*this.speed:this.position.y>t.position.y+t.size.height&&(this.position.y+=this.direction.y*this.speed),s=!0),e&&s&&(this.position.x<t.position.x&&this.direction.x>0||this.position.x>t.position.x&&this.direction.x<0?this.direction.x=-this.direction.x:(this.position.y<t.position.y&&this.direction.y>0||this.position.y>t.position.y&&this.direction.y<0)&&(this.direction.y=-this.direction.y))}}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Asteroid=function(e){function t(e,i){_classCallCheck(this,t);var s=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return s.size={width:i.width,height:i.height},s.position={x:i.x||Math.floor(Math.random()*(s.game.world.width-s.size.width)),y:i.y||Math.floor(Math.random()*(s.game.world.height-s.size.height))},s.direction={x:Math.random(),y:Math.random()},s.attack.range=5,s.speed=2*Math.random(),s.speed=3,s.animation.name="monster",s.target=i.target||null,s.density=.03,s}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.arc(this.position.x+this.size.width/2-this.game.camera.x,this.position.y+this.size.height/2-this.game.camera.y,(this.size.width+this.size.height)/6,0,2*Math.PI),this.game.screen.fillStyle="rgba(0,0,0,0.2)",this.game.screen.fill();var e=this.vectorAngle({x:this.position.x-this.game.camera.x,y:this.position.y-this.game.camera.y},{x:this.position.x-this.game.camera.x+this.look.x,y:this.position.y-this.game.camera.y+this.look.y});this.game.sprite.draw(this,e),this.healthBar()}},{key:"update",value:function(){this.brotherColliding(),this.willDie||(this.willAttack||this.isReach(this.target)?(this.willAttack=!0,this.changeAnimation("attack"),this.animation.end&&(this.willAttack=!1,this.isReach(this.target)&&(console.log("hit you"),this.target.hit(this.getRandomInt(this.attack.damageMin,this.attack.damageMax))),this.changeAnimation("stand"))):this.speed?(this.target&&this.routeToTarget(),this.changeAnimation("walk"),this.faceBarrier(),this.position.x+=this.direction.x*this.speed,this.position.y+=this.direction.y*this.speed):this.changeAnimation("stand"))}},{key:"routeToTarget",value:function(){var e=this.directionTo({position:{x:this.target.position.x,y:this.target.position.y},size:{width:this.size.width,height:this.size.height}});this.direction.x+=(e.x-this.direction.x)*this.rotationSpeed,this.direction.y+=(e.y-this.direction.y)*this.rotationSpeed,this.look.x+=(e.x-this.look.x)*this.rotationSpeed,this.look.y+=(e.y-this.look.y)*this.rotationSpeed}}]),t}(Basis),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Builder=function(){function e(t){_classCallCheck(this,e),this.game=t,this.size={width:24,height:24},this.position={x:0,y:0,sx:0,sy:0},this.speed=3,this.material={sx:0,sy:0},this.addActivity()}return _createClass(e,[{key:"update",value:function(){this.position.sx=this.game.point.x+this.game.camera.x-(this.game.point.x+this.game.camera.x)%this.size.width,this.position.sy=this.game.point.y+this.game.camera.y-(this.game.point.y+this.game.camera.y)%this.size.width,this.move()}},{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.strokeStyle="black",this.game.screen.rect(this.position.sx-this.game.camera.x,this.position.sy-this.game.camera.y,this.size.width,this.size.height),this.game.screen.stroke(),this.game.screen.beginPath(),this.game.screen.fillStyle="white",this.game.screen.fillRect(this.game.camera.width-240,this.game.camera.height-360,240,360),this.game.screen.stroke(),this.game.screen.drawImage(this.game.stage.image,0,0,240,360,this.game.camera.width-240,this.game.camera.height-360,240,360),this.game.screen.beginPath(),this.game.screen.strokeStyle="red",this.game.screen.rect(this.game.camera.width-240+this.material.sx,this.game.camera.height-360+this.material.sy,this.size.width,this.size.height),this.game.screen.stroke()}},{key:"move",value:function(){this.position.sx,this.position.sy;this.game.keyboard.isPressed("A")?this.position.x-=this.speed:this.game.keyboard.isPressed("D")&&(this.position.x+=this.speed),this.game.keyboard.isPressed("W")?this.position.y-=this.speed:this.game.keyboard.isPressed("S")&&(this.position.y+=this.speed)}},{key:"addActivity",value:function(){var e=this,t=this.game.keyboard,i=this.game;document.addEventListener("mousedown",function(t){if(t.x>i.camera.width-240&&t.y>i.camera.height-360){var s=t.x-(i.camera.width-240),a=t.y-(i.camera.height-360);s-=s%e.size.width,a-=a%e.size.height,e.material.sx=s,e.material.sy=a,console.log(e.material.sx,e.material.sy)}else e.game.stage.build({x:e.position.sx,y:e.position.sy,sx:e.material.sx,sy:e.material.sy})}),document.addEventListener("keydown",function(i){t.isClicked("SPACE",i.keyCode)&&(e.game.stage.addSolid(e.position.sx,e.position.sy),e.game.stage.simplifySolid()),t.isClicked("C",i.keyCode)&&e.game.stage.clean(),t.isClicked("R",i.keyCode)&&e.game.stage.remove(e.position.sx,e.position.sy),t.isClicked("1",i.keyCode)&&e.game.stage.simplifySolid(),t.isClicked("F3",i.keyCode)&&e.game.stage.logLevel(),t.isClicked("F4",i.keyCode)&&e.game.stage.loadLevel("1")})}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Bullet=function(e){function t(e,i,s){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return a.size.width=24,a.size.height=24,a.position.x=i.x-a.size.width/2,a.position.y=i.y-a.size.height/2,a.direction=i.direction,a.speed=5,a.animation.name="bullet",a.attack.damage=i.damage,a.owner=s,a.timer=a.game.timer,a}return _inherits(t,e),_createClass(t,[{key:"update",value:function(){this.isOuterCamera()&&this.game.removeBody(this);for(var e,i=0;i<this.game.bodies.length;i++)e=this.game.bodies[i],this.willDie||e.willDie||this.owner===e||e instanceof t||!this.collidingBody(e)||(this.kill(),this.speed=0,e.hit(this.attack.damage));this.position.x+=this.direction.x*this.speed,this.position.y+=this.direction.y*this.speed,this.faceBarrier(!0),this.game.timer>this.timer+100&&(this.kill(),this.speed=0)}},{key:"render",value:function(){var e=this.vectorAngle({x:this.position.x-this.game.camera.x,y:this.position.y-this.game.camera.y},{x:this.position.x-this.game.camera.x+this.direction.x*this.speed,y:this.position.y-this.game.camera.y+this.direction.y*this.speed});this.game.sprite.draw(this,e)}}]),t}(Basis),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Game=function(){function e(){_classCallCheck(this,e);var t=this;this.editMode=!1,this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas),this.canvas.width=document.body.offsetWidth-10,this.canvas.height=document.body.offsetHeight-10,this.screen=this.canvas.getContext("2d"),this.screen.imageSmoothingEnabled=!1,this.camera={x:0,y:0,width:this.canvas.width,height:this.canvas.height,target:null,stretch:.2},this.world={width:792,height:792},this.player=new Player(t),this.playerControl=new PlayerControl(t),this.socket=new Socket(t),this.builder=null,this.keyboard=new Keyboard,this.point=new Point(t.canvas),this.sprite=new Sprite(t),this.stage=new Stage(t),this.lastTick=new Date,this.timer=0,this.camera.target=this.player,this.bodies=[],this.addBody(this.player);for(var i=0;0>i;i++)t.addBody(new Asteroid(t,{target:t.player,width:48,height:48}));var s=function a(){t.update(),t.render(),requestAnimationFrame(a)};s(),this.modeToggler()}return _createClass(e,[{key:"render",value:function(){this.screen.clearRect(0,0,this.camera.width,this.camera.height);var e=new Date,t=Math.round(1e3/(e-this.lastTick));this.lastTick=e,this.stage.render(),this.debug(["FPS: "+t,"Obj count: "+this.bodies.length,"Stage count: "+this.stage.level.length,"Camera (x: "+this.camera.x.toFixed()+", y: "+this.camera.y.toFixed()+")","Player (x: "+this.player.position.x.toFixed()+", y: "+this.player.position.y.toFixed()+")","Player dir(x: "+this.player.direction.x+", y: "+this.player.direction.y+")"]),this.screen.rect(0-this.camera.x,0-this.camera.y,this.world.width,this.world.height),this.screen.stroke();for(var i,s=0;s<this.bodies.length;s++)i=this.bodies[s],this.isCameraShow(this.bodies[s])&&i.render()}},{key:"update",value:function(){this.timer++,this.camera.x=this.camera.target.position.x-this.camera.width/2+this.camera.target.size.width/2,this.camera.y=this.camera.target.position.y-this.camera.height/2+this.camera.target.size.height/2,this.camera.x+=(this.point.x-this.camera.width/2)*this.camera.stretch,this.camera.y+=(this.point.y-this.camera.height/2)*this.camera.stretch,this.playerControl.update();for(var e,t=0;t<this.bodies.length;t++)e=this.bodies[t],e.willDie&&e.animation.end?(this.removeBody(e),t--):e.update()}},{key:"addBody",value:function(e){this.bodies.push(e)}},{key:"removeBody",value:function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++)for(var i=0;i<this.bodies.length;i++)e[t]==this.bodies[i]&&(this.bodies.splice(i,1),i--)}},{key:"debug",value:function(e){this.screen.fillStyle="#000";for(var t=0;t<e.length;t++)this.screen.fillText(e[t],10,18*(t+1));this.screen.fillText("W",40,this.camera.height-40),this.screen.fillText("S",40,this.camera.height-20),this.screen.fillText("A",20,this.camera.height-20),this.screen.fillText("D",60,this.camera.height-20),this.screen.beginPath(),this.screen.moveTo(35,this.camera.height-55),this.screen.lineTo(55,this.camera.height-55),this.screen.lineTo(55,this.camera.height-35),this.screen.lineTo(75,this.camera.height-35),this.screen.lineTo(75,this.camera.height-15),this.screen.lineTo(15,this.camera.height-15),this.screen.lineTo(15,this.camera.height-35),this.screen.lineTo(35,this.camera.height-35),this.screen.lineTo(35,this.camera.height-55),this.screen.stroke()}},{key:"isCameraShow",value:function(e){return!(e.position.x+e.size.width<this.camera.x&&e.position.x>this.camera.width&&e.position.y+e.size.height<this.camera.y&&e.position.y>this.camera.width)}},{key:"modeToggler",value:function(){var e=this;document.addEventListener("keydown",function(t){113==t.keyCode&&(e.builder=new Builder(e),e.camera.target=e.builder,e.camera.stretch=0,e.bodies=[],e.addBody(e.builder))})}}]),e}(),Keyboard=function e(){_classCallCheck(this,e);var t={},i={SPACE:32,A:65,W:87,D:68,S:83,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,F:70,G:71,H:72,C:67,R:82,F2:113,F3:114,F4:115,F5:116,LEFT:37,UP:38,RIGHT:39,DOWN:40};document.addEventListener("keydown",function(e){e.preventDefault(),t[e.keyCode]=!0}),document.addEventListener("keyup",function(e){t[e.keyCode]=!1}),this.isPressed=function(e){return e=e.toUpperCase(),t[i[e]]},this.isClicked=function(e,t){return i[e]===t},this.keyCode=function(e){return e=e.toUpperCase(),i[e]}},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Player=function(e){function t(e,i){_classCallCheck(this,t),i=i||{};var s=_possibleConstructorReturn(this,Object.getPrototypeOf(t).call(this,e));return s.id=null,s.speed=3,s.size.width=48,s.size.height=48,s.position.x=i.x||e.world.width/2-s.size.width/2,s.position.y=i.y||e.world.height/2-s.size.height/2,s.shooting={start:!1,bullet:1,rate:3,reload:0},s.attack={damageMin:5,damageMax:10,range:10},s.animation.name="player",s}return _inherits(t,e),_createClass(t,[{key:"render",value:function(){this.game.screen.beginPath(),this.game.screen.arc(this.position.x+this.size.width/2-this.game.camera.x,this.position.y+this.size.height/2-this.game.camera.y,(this.size.width+this.size.height)/6,0,2*Math.PI),this.game.screen.fillStyle="rgba(0,0,0,0.2)",this.game.screen.fill(),this.game.sprite.draw(this,this.lookAngel),this.healthBar()}},{key:"update",value:function(){this.shot(),this.move()}},{key:"move",value:function(){this.faceBarrier(),this.position.x+=this.direction.x*this.speed,this.position.y+=this.direction.y*this.speed,this.direction.x||this.direction.y?this.changeAnimation("walk"):this.changeAnimation("stand")}},{key:"shot",value:function(){if(!this.shooting.bullet&&++this.shooting.reload>=60/this.shooting.rate&&(this.shooting.bullet=1,this.shooting.reload=0),this.shooting.bullet&&this.shooting.start){this.shooting.bullet=0;var e={x:this.position.x+this.size.width/2,y:this.position.y+this.size.height/2,direction:this.directionTo({position:{x:this.game.point.x+this.game.camera.x,y:this.game.point.y+this.game.camera.y},size:{width:0,height:0}}),damage:this.getRandomInt(this.attack.damageMin,this.attack.damageMax)};this.game.addBody(new Bullet(this.game,e,this.game.player)),this.game.socket.shot(e)}}}]),t}(Basis),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),PlayerControl=function(){function e(t){_classCallCheck(this,e),this.game=t,setInterval(function(){t.player&&(t.socket.move(t.player),!t.player.willDie&&t.player.health.current<=0&&this.game.socket.kill(this.id))},50)}return _createClass(e,[{key:"update",value:function(){this.move(),this.shot(),this.rotate()}},{key:"move",value:function(){var e=this.game.player;e.direction.x=0,e.direction.y=0,this.game.keyboard.isPressed("A")?e.direction.x=-1:this.game.keyboard.isPressed("D")&&(e.direction.x=1),this.game.keyboard.isPressed("W")?e.direction.y=-1:this.game.keyboard.isPressed("S")&&(e.direction.y=1)}},{key:"shot",value:function(){this.game.player.shooting.start=this.game.point.isPressed("LEFT")||this.game.keyboard.isPressed("SPACE")}},{key:"rotate",value:function(){this.game.player.lookAngel=this.game.player.vectorAngle({x:this.game.player.position.x-this.game.camera.x+this.game.player.size.width/2,y:this.game.player.position.y-this.game.camera.y+this.game.player.size.width/2},{x:this.game.point.x,y:this.game.point.y})}}]),e}(),Point=function t(e){_classCallCheck(this,t);var i=this,s={},a={LEFT:0,RIGHT:2,MIDDLE:1};this.x=0,this.y=0,e.addEventListener("mousemove",function(e){i.x=e.clientX,i.y=e.clientY}),e.addEventListener("mousedown",function(e){e.preventDefault(),s[e.button]=!0}),e.addEventListener("mouseup",function(e){e.preventDefault(),s[e.button]=!1}),this.isPressed=function(e){return e=e.toUpperCase(),s[a[e]]}},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Socket=function(){function e(t){function i(e){t.player.id=e.socketId;for(var i=0;i<e.game.length;i++)e.socketId===e.game[i].socketId?(t.player.id=e.socketId,t.player.position=e.game[i].position):n(e.game[i]);r.move(t.player)}function s(e){c[e.socketId]&&(c[e.socketId].willDie=!0,delete c[e.socketId])}function a(e){c[e.socketId]||n(e),c[e.socketId].position=e.position,c[e.socketId].lookAngel=e.lookAngel,c[e.socketId].direction=e.direction}function n(e){var i=new Player(t,e.position);c[e.socketId]=i,c[e.socketId].id=e.socketId,c[e.socketId].lookAngel=e.lookAngel,t.bodies.push(i)}function o(e){t.addBody(new Bullet(t,e.bullet,c[e.socketId]))}function h(e){t.player.id==e.socketId&&t.player&&t.player.kill(),c[e.socketId]&&c[e.socketId].kill()}_classCallCheck(this,e);var r=this,l=io.connect();this.socket=l;var c={};l.on("connected",i),l.on("leave",s),l.on("move",a),l.on("join",n),l.on("bullet",o),l.on("kill",h)}return _createClass(e,[{key:"move",value:function(e){this.socket.emit("move",{position:e.position,lookAngel:e.lookAngel,direction:e.direction})}},{key:"shot",value:function(e){this.socket.emit("bullet",e)}},{key:"kill",value:function(e){this.socket.emit("kill",e)}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Sprite=function(){function e(t){_classCallCheck(this,e),this.game=t,this.dir="/sprites/sprite.png",this.image=new Image,this.image.src=this.dir,this.size={width:48,height:48},this.collection={player:{stand:[{x:0,y:0}],walk:[{x:0,y:0},{x:48,y:0},{x:96,y:0},{x:144,y:0},{x:0,y:48},{x:48,y:48},{x:96,y:48},{x:144,y:48}],die:[{x:0,y:336},{x:0,y:336},{x:48,y:336},{x:48,y:336}]},monster:{stand:[{x:0,y:144}],walk:[{x:0,y:144},{x:48,y:144},{x:96,y:144},{x:144,y:144},{x:0,y:192},{x:48,y:192},{x:96,y:192},{x:144,y:192}],bite:[{x:0,y:240},{x:48,y:240},{x:96,y:240}],attack:[{x:0,y:288},{x:48,y:288},{x:96,y:288},{x:144,y:288},{x:192,y:288}],die:[{x:0,y:336},{x:0,y:336},{x:48,y:336},{x:48,y:336}]},bullet:{stand:[{x:0,y:96,w:24,h:24}],die:[{x:0,y:120,w:24,h:24},{x:24,y:120,w:24,h:24}]}}}return _createClass(e,[{key:"draw",value:function(e,t){var i=e.position.x+e.size.width/2-this.game.camera.x,s=e.position.y+e.size.height/2-this.game.camera.y;t-=90;var a=this.getFrame(e.animation);this.game.screen.save(),this.game.screen.translate(i,s),this.game.screen.rotate(t*Math.PI/180),this.game.screen.drawImage(this.image,a.x,a.y,a.w||this.size.width,a.h||this.size.height,-e.size.width/2,-e.size.width/2,e.size.width,e.size.height),this.game.screen.translate(-i,-s),this.game.screen.rotate(-t*Math.PI/180),this.game.screen.restore()}},{key:"getFrame",value:function(e){var t=this.collection[e.name][e.state];return this.game.timer%e.rate==0&&(t.length-1>e.keyframe?e.keyframe+=1:(e.keyframe=0,e.end=!0)),t[e.keyframe]}}]),e}(),_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,i,s){return i&&e(t.prototype,i),s&&e(t,s),t}}(),Stage=function(){function e(t){_classCallCheck(this,e);this.game=t,this.dir="/sprites/tileset.png",this.image=new Image,this.image.src=this.dir,this.current=1,this.size={width:24,height:24},this.level=[],this.levelSolid=[],this.loadLevel("1")}return _createClass(e,[{key:"render",value:function(){this.game.screen.fillStyle="#161318",this.game.screen.fillRect(0-this.game.camera.x,0-this.game.camera.y,this.game.world.width,this.game.world.height);for(var e=0;e<this.level.length;e++)this.draw(this.level[e]);if(this.game.builder)for(var e=0;e<this.levelSolid.length;e++)this.game.screen.beginPath(),this.game.screen.fillStyle="rgba(255, 0, 0, 0.3)",this.game.screen.fillRect(this.levelSolid[e].x+2-this.game.camera.x,this.levelSolid[e].y+2-this.game.camera.y,this.levelSolid[e].width-4,this.levelSolid[e].height-4),this.game.screen.stroke()}},{key:"draw",value:function(e){e.x+this.size.width>this.game.camera.x&&e.x<this.game.camera.x+this.game.camera.width&&e.y+this.size.height>this.game.camera.y&&e.y<this.game.camera.y+this.game.camera.height&&this.game.screen.drawImage(this.image,e.sx,e.sy,this.size.width,this.size.height,e.x-this.game.camera.x,e.y-this.game.camera.y,this.size.width,this.size.height)}},{key:"build",value:function(e){this.level.push(e)}},{key:"clean",value:function(){for(var e,t=0;t<this.level.length;t++){e=this.level[t];for(var i,s=0;s<this.level.length;s++)if(i=this.level[s],e!=i&&e.x===i.x&&e.y===i.y){this.level.splice(t,1),t--;break}}}},{key:"remove",value:function(e,t){for(var i=0;i<this.level.length;i++)if(this.level[i].x===e&&this.level[i].y===t){this.level.splice(i,1);break}}},{key:"loadLevel",value:function(e){var t=new XMLHttpRequest,i=this;t.overrideMimeType("application/json"),t.open("GET","/levels/level_"+e+".json",!0),t.onreadystatechange=function(){if(4==t.readyState&&"200"==t.status){var e=JSON.parse(t.responseText);i.level=e.tiles,i.levelSolid=e.solids}},t.send(null)}},{key:"logLevel",value:function(){console.log(JSON.stringify(this.level)),console.log("=============================="),console.log(JSON.stringify(this.levelSolid))}},{key:"addSolid",value:function(e,t){this.levelSolid.push({x:e,y:t,width:this.size.width,height:this.size.height})}},{key:"simplifySolid",value:function(){console.log("before simplify",this.levelSolid.length);for(var e,t=0;t<this.levelSolid.length;t++)if(e=this.levelSolid[t]){for(var i,s=!1,a=0;a<this.levelSolid.length;a++)i=this.levelSolid[a],i&&e!=i&&e.x<=i.x+i.width&&e.x+e.width>=i.x&&e.y<=i.y+i.height&&e.height+e.y>=i.y&&(e.x===i.x&&e.width===i.width||e.y===i.y&&e.height===i.height)&&(i.x<e.x?(e.x-=i.width,e.width+=i.width):i.x>e.x?e.width+=i.width:i.y<e.y?(e.y-=i.height,e.height+=i.height):i.y>e.y&&(e.height+=i.height),s=!0,delete this.levelSolid[a]);s&&t--}this.levelSolid=this.levelSolid.filter(function(e){return!!e})}}]),e}(),Vector=function i(e,t){_classCallCheck(this,i),this.x=e,this.y=t};